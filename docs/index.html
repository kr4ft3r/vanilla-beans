<!DOCTYPE html>
<html>
        <head>
                <link rel="stylesheet" type="text/css" href="vanilla-beans.css">
                <script src="vanilla-beans.min.js"></script>
                <script type="text/javascript">
                        const demoData = {
                                spriteDefinitions: {},
                                sprites: [],
                                spritesData: [], // Stuff otherwise encapsulated by game object
                                containerElem: null,
                                collisionGrid: null
                        };
                        
                        function domReady(fn) {
                                // If we're early to the party
                                document.addEventListener("DOMContentLoaded", fn);
                                // If late; I mean on time.
                                if (document.readyState === "interactive" || document.readyState === "complete" ) {
                                        fn();
                                }
                        }

                        domReady(() => domLoaded());

                        function domLoaded() {
                                console.log("hello");
                                demoData.spriteDefinitions['heart'] = new SpriteDefinition('test', './heart.png', 64, 64);
                                const containerElem = document.getElementById('test-container');
                                demoData.containerElem = containerElem;
                                
                                //demoData.spriteElem = spriteElem;
                                demoData.collisionGrid = new FixedResolutionGrid(
                                        128, 8, 6,
                                        (s, p) => { const b = s.getBoundingBox();
                                                return b.x1 <= p.x && b.y1 <= p.y &&
                                                b.x2 >= p.x && b.y2 >= p.y;},
                                        (s1, s2) => { const b1 = s1.getBoundingBox(); const b2 = s2.getBoundingBox();
                                                return Collision.simpleBoxesOverlap(b1, b2);
                                        }
                                        );
                                createSprite();
                                
                                containerElem.addEventListener("click", spriteContainerClicked);
                                
                                window.requestAnimationFrame(frame);
                                
                        }
                        
                        function createSprite() {
                                const spriteDef = demoData.spriteDefinitions['heart'];
                                let sprite = new Sprite(
                                        'heart'+demoData.sprites.length, 
                                        spriteDef, 
                                        {position: {x:100, y:100}, scale: {x:1.0,y:1.0}}
                                );
                                Sprite.addToContainer(demoData.containerElem, sprite);
                                
                                demoData.sprites.push(sprite);
                                demoData.spritesData.push({directionX:1, timeAlive:0.0});
                                demoData.collisionGrid.insert(sprite, sprite.getBoundingBox());
                        }
                        
                        function spriteContainerClicked(event) {
                                const rect = event.currentTarget.getBoundingClientRect();
                                const point = {
                                        x: event.clientX - rect.left,
                                        y: event.clientY - rect.top
                                }
                                //console.log(point);
                                const hits = demoData.collisionGrid.getAtPoint(point);
                                console.log(hits);
                                if (hits.length > 0) {
                                        if (demoData.sprites.length == 3) {
                                                const sprite = hits[0];
                                                Sprite.removeFromContainer(sprite);
                                                demoData.collisionGrid.remove(sprite, sprite.getBoundingBox());
                                        } else {
                                                createSprite();
                                        }
                                }
                        }
                        
                        var previousFrameTimestamp = null;
                        function frame(timestamp) {
                                if (previousFrameTimestamp === null) previousFrameTimestamp = timestamp;
                                const deltaTime = (timestamp - previousFrameTimestamp) * 0.001;

                                for (let i = 0; i < demoData.sprites.length; i++) {
                                        let sprite = demoData.sprites[i];
                                        let data = demoData.spritesData[i];
                                        data.timeAlive += deltaTime;
                                        if (sprite.domElement === null) continue;
                                        let xMod = 300;
                                        if (sprite.transform.position.x >= 924) data.directionX = -1;
                                        else if (sprite.transform.position.x <= 100) data.directionX = 1;
                                        xMod *= data.directionX;
                                        let movement = {
                                                x: sprite.transform.position.x,
                                                y: sprite.transform.position.y
                                        };
                                        const newX = sprite.transform.position.x + xMod*0.02;
                                        const newY = 100 + Math.sin(data.timeAlive*3)*60;
                                        movement.x -= newX;
                                        movement.y -= newY;
                                        demoData.collisionGrid.update(sprite, sprite.getBoundingBox(), movement);
                                        
                                        const collisions = demoData.collisionGrid.getCollisions(
                                                sprite, sprite.getBoundingBox());
                                        if (collisions.length > 0) {
                                                if (collisions[0].transform.position.x > sprite.transform.position.x) {
                                                        data.directionX = -1
                                                } else {
                                                        data.directionX = 1;
                                                }
                                        }
                                                
                                        sprite.transform.position.x = newX;
                                        sprite.transform.position.y = newY;
                                        sprite.update();
                                }
                                
                                previousFrameTimestamp = timestamp;
                                window.requestAnimationFrame(frame);
                        }
                        
                </script>
        </head>
        <body style="margin:0;padding:0;background-color:#000000;color:#F3E5AB;">
                <div id="test-container" style="width:1024px; height:768px; margin: 0 auto; position: relative; background-color:darkslateblue">
                        <h1 style="display:block;position:absolute">Vanilla Beans</h1>
                </div>
        </body>
</html>