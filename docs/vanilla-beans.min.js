class FixedResolutionGrid{constructor(cellSize,gridWidth,gridHeight,pointCollisionTest,elementsCollisionTest){this.cellSize=cellSize,this.width=gridWidth,this.height=gridHeight,this.pointCollisionTest=pointCollisionTest,this.elementsCollisionTest=elementsCollisionTest,this.cells=new Array(gridHeight).fill(new Array(gridWidth).fill([],0,gridWidth),0,gridWidth)}_getCoordsAtPoint(x,y){return[Math.floor(x/this.cellSize),Math.floor(y/this.cellSize)]}_getCell(boundingBox){var[boundingBox,y]=this._getCoordsAtPoint(boundingBox.x1+.5*(boundingBox.x2-boundingBox.x1),boundingBox.y1+.5*(boundingBox.y2-boundingBox.y1));if(!(y>=this.height))return this.cells[y][boundingBox]}insert(value,boundingBox){boundingBox=this._getCell(boundingBox);void 0!==boundingBox&&boundingBox.push(value)}remove(value,boundingBox){var cell=this._getCell(boundingBox);if(void 0!==cell)for(let i=0;i<cell.length;i++)if(value===cell[i]){cell.splice(i,1);break}}update(value,boundingBox,movement){if(0!==movement.x||0!==movement.y){var[prevX,prevY]=this._getCoordsAtPoint(boundingBox.x1+.5*(boundingBox.x2-boundingBox.x1),boundingBox.y1+.5*(boundingBox.y2-boundingBox.y1)),[movement,boundingBox]=this._getCoordsAtPoint(movement.x+boundingBox.x1+.5*(boundingBox.x2-boundingBox.x1),movement.y+boundingBox.y1+.5*(boundingBox.y2-boundingBox.y1));if(prevX!==movement||prevY!==boundingBox){if(0<=prevY&&prevY<this.height&&0<=prevX&&prevX<this.width){var prevCell=this.cells[prevY][prevX];for(let i=0;i<prevCell.length;i++)value===prevCell[i]&&prevCell.splice(i,1)}0<=boundingBox&&boundingBox<this.height&&0<=movement&&movement<this.width&&this.cells[boundingBox][movement].push(value)}}}getAtPoint(point){var[x,y]=this._getCoordsAtPoint(point.x,point.y),cell=(this.debug&&console.log(x+"|"+y+" CHECKING"),this.cells[y][x]),hits=[];for(let i=0;i<cell.length;i++)this.pointCollisionTest(cell[i],point)&&hits.push(cell[i]);return hits}getCollisions(value,boundingBox){var cellX1=Math.floor(boundingBox.x1/this.cellSize),cellY1=Math.floor(boundingBox.y1/this.cellSize),cellX2=Math.floor(boundingBox.x2/this.cellSize),cellsY=[cellY1,Math.floor(boundingBox.y2/this.cellSize)],cellsX=[cellX1,cellX2],hits=[];for(let yi=0;yi<cellsY.length;yi++){var y=cellsY[yi];if(!(y>=this.height))for(let xi=0;xi<cellsX.length;xi++){var x=cellsX[xi];if(!(x>=this.width)){var cell=this.cells[y][x];for(let i=0;i<cell.length;i++)cell[i]!==value&&this.elementsCollisionTest(value,cell[i])&&hits.push(cell[i])}}}return hits}}class HashTable{constructor(){this.table=new Array(127),this.size=0}*[Symbol.iterator](){for(let i=0;i<this.size;i++){if(!this.table[i]||!this.table[i].length)continue;for(let y=0;y<this.table[i].length;y++)yield this.table[i][y][1]}}_hash(key){let hash=0;for(let i=0;i<key.length;i++)hash+=key.charCodeAt(i);return hash%this.table.length}set(key,value){var index=this._hash(key);if(this.table[index]){for(let i=0;i<this.table[index].length;i++)if(this.table[index][i]===key)return void(this.table[index][i][1]=value)}else this.table[index]=[];this.table[index].push([key,value]),this.size++}get(key){var index=this._hash(key);if(this.table[index])for(let i=0;i<this.table[index].length;i++)if(this.table[index][i][0]===key)return this.table[index][i][1]}remove(key){var index=this._hash(key);if(this.table[index]&&this.table[index].length)for(let i=0;i<this.table[index].length;i++)if(this.table[index][i][0]===key)return this.table[index].splice(i,1),this.size--,!0;return!1}toString(){let table="";return this.table.forEach((values,index)=>{values=values.map((key,value)=>`[ ${key}: ${value} ]`);table+=index+" => "+values+"\n"}),table}}class Queue{constructor(){this.items={},this.frontIndex=0,this.backIndex=0}enqueue(item){return this.items[this.backIndex]=item,this.backIndex++,item+" inserted"}dequeue(){var item=this.items[this.frontIndex];return delete this.items[this.frontIndex],this.frontIndex++,item}peek(){return this.items[this.frontIndex]}isEmpty(){return 0==Object.keys(this.items).length}get printQueue(){return this.items}}class FullBinaryTree{}class FBTNode{constructor(data){this.data=data,this.left=null,this.right=null}}class MaxHeap{constructor(data=[]){this.data=data,this.comp={lt:(a,b)=>a<b,gt:(a,b)=>b<a}}add(element){element=this.data.push(element);this.heapify(this.data,element,0)}heapify(data,length,index){let largest=index;var left=2*index+1,right=2*index+2;left<length&&this.comp.gt(data[left],data[index])&&(largest=left),(largest=right<length&&this.comp.gt(data[right]>data[index])?right:largest)!=index&&([data[index],data[largest]]=[data[largest],data[index]],heapify(data,length,largest))}}class Tree{constructor(root=null,comparer){this.root=root,this.comparer=comparer}}class TNode{constructor(data,parent=0){this.data=data,this.children=[]}addChild(node){return(node.parent=this).children.push(node),this.children.length}}class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}getMagnitude(){return Math.sqrt(this.x**2+this.y**2)}getDirection(){return Math.atan2(this.y,this.x)}setMagnitude(magnitude){var dir=this.getDirection();this.x=Math.cos(dir)*magnitude,this.y=Math.sin(dir)*magnitude}setDirection(dir){var magnitude=this.getMagnitude();this.x=Math.cos(dir)*magnitude,this.y=Math.sin(dir)*magnitude}addVector(v){this.x+=v.x,this.y+=v.y}substractVector(v){this.x-=v.x,this.y-=v.y}multiplyBy(amount){this.x*=amount,this.y*=amount}normalize(){var magnitude=this.getMagnitude();0!==magnitude&&(this.x/=magnitude,this.y/=magnitude)}clone(){return new Vector2(this.x,this.y)}}Vector2.Up=new Vector2(0,1),Vector2.Right=new Vector2(1,0),Vector2.Zero=new Vector2(0,0),Vector2.add=(v1,v2)=>new Vector2(v1.x+v2.x,v1.y+v2.y),Vector2.sub=(v1,v2)=>new Vector2(v1.x-v2.x,v1.y-v2.y),Vector2.mul=(v,amount)=>new Vector2(v.x*amount,v.y*amount),Vector2.dot=(v1,v2)=>v1.x*v2.x+v1.y*v2.y,Vector2.norm=v=>{var v=new Vector2(v.x,v.y),magnitude=v.getMagnitude();return 0!==magnitude&&(v.x/=magnitude,v.y/=magnitude),v};class Input{constructor(name){this.name=name,this.keysDown={},document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,Events.instance.createEvent(this.name+"KeyDown"),Events.instance.createEvent(this.name+"KeyUp"),Input.activeInput=this}isKeyDown(code){return code in this.keysDown&&this.keysDown[code]}onKeyDown(evt){evt=evt||window.event,Events.instance.dispatch(Input.activeInput.name+"KeyDown",evt.keyCode)}onKeyUp(evt){evt=evt||window.event,Events.instance.dispatch(Input.activeInput.name+"KeyUp",evt.keyCode)}}Input.activeInput=null;class Sprite{constructor(id,spriteDefinition,transform){this.id=id,this.definition=spriteDefinition,"rotation"in(this.transform=transform)||(this.transform.rotation=0),"positionUnit"in transform||(this.transform.positionUnit="px"),"rotationUnit"in transform||(this.transform.rotationUnit="rad"),this.container=null,this.domElement=null,this.sheetPosition={x:0,y:0},Sprite.idMap.set(id,this)}getBoundingBox(){return{x1:this.transform.position.x,y1:this.transform.position.y,x2:this.transform.position.x+this.definition.width*this.transform.scale.x,y2:this.transform.position.y+this.definition.height*this.transform.scale.y}}toHtml(){return`
                <div id="sprite_${this.definition.id}_${this.id}" class="vb__sprite"
                style="background-image:url(${this.definition.imagePath});width:${Math.round(this.getWidth())}px;height:${Math.round(this.getHeight())}px;
                background-size: ${Math.round(this.getWidth())}px ${Math.round(this.getHeight())}px;
                transform: translate(${this.transform.position.x}${this.transform.positionUnit}, ${this.transform.position.y}${this.transform.positionUnit}) rotate(${this.transform.rotation}${this.transform.rotationUnit})"
                ></div>
                `}update(){var elem,sheetPos;null!==this.domElement&&(this.domElement=document.getElementById("sprite_"+this.definition.id+"_"+this.id),(elem=this.domElement).style.width=this.getWidth()+"px",elem.style.height=this.getHeight()+"px",elem.style.backgroundSize=`${this.getWidth()*this.definition.sheet.width}px ${this.getHeight()*this.definition.sheet.height}px`,(1<this.definition.sheet.width||1<this.definition.sheet.height)&&(sheetPos=this.getSheetPosition(),elem.style.backgroundPosition=`${-1*sheetPos.x}px ${-1*sheetPos.y}px`),elem.style.transform="translate("+this.transform.position.x+this.transform.positionUnit+", "+this.transform.position.y+this.transform.positionUnit+") rotate("+this.transform.rotation+this.transform.rotationUnit+")")}getWidth(){return this.definition.width*this.transform.scale.x}getHeight(){return this.definition.height*this.transform.scale.y}getSheetPosition(){return{x:this.getWidth()*this.sheetPosition.x,y:this.getHeight()*this.sheetPosition.y}}}Sprite.addToContainer=function(containerElem,sprite){null!==sprite.container&&Sprite.removeFromContainer(sprite),containerElem.innerHTML+=sprite.toHtml();var cs=(sprite.container=containerElem).querySelectorAll(":scope > .vb__sprite");for(let i=0;i<cs.length;i++){var id=cs[i].id.split("_")[2];Sprite.idMap.get(id).domElement=cs[i]}},Sprite.removeFromContainer=function(sprite){var spriteElem;null!==sprite.container&&null!==(spriteElem=sprite.domElement)&&(spriteElem.remove(),sprite.domElement=null)},Sprite.idMap=new HashTable;class SpriteDefinition{constructor(id,imagePath,widthPx,heightPx,sheet=null){this.id=id,this.imagePath=imagePath,this.width=widthPx,this.height=heightPx,this.sheet=sheet=null===sheet?{width:1,height:1}:sheet,SpriteDefinition.table.set(id,this)}}SpriteDefinition.table=new HashTable;class StoryWindow{constructor(windowElem,textElem,popInCallback,popOutCallback){this.windowElem=windowElem,this.textElem=textElem,this.popInCallback=popInCallback,this.popOutCallback=popOutCallback,this.visible=!1,this.typewriter={running:!1,delay:.1,text:"",length:0,head:0,time:0,headStyle:"normal",lineBreaks:[]}}popIn(data){this.visible=!0,null!==this.popInCallback&&this.popInCallback(data,this)}popOut(data){this.visible=!1,null!==this.popOutCallback&&this.popOutCallback(data,this)}write(text){this.typewriter.running=!0,this.typewriter.text=this._parse(text),this.typewriter.visibleBuffer="",this.typewriter.hiddenBuffer=this.typewriter.text,this.typewriter.length=this.typewriter.text.length,this.typewriter.head=-1,this.typewriter.headStyle="normal",this.typewriter.time=0,this.textElem.innerHTML=""}update(deltaTime){if(this.typewriter.running&&(this.typewriter.time+=deltaTime,this.typewriter.time>=this.typewriter.delay)){let char="";if(this.typewriter.time=0,this.typewriter.head++,this.typewriter.head>=this.typewriter.length)this.typewriter.running=!1,this.textElem.innerHTML=`${this.typewriter.visibleBuffer}<span style="visibility:hidden;">${this.typewriter.hiddenBuffer}</span>`;else{let isSpecial=!0;""===(char=this._headGetSpecialChar())&&(isSpecial=!1,char=this.typewriter.text[this.typewriter.head],this.typewriter.hiddenBuffer=this.typewriter.hiddenBuffer.substring(1)),this.typewriter.visibleBuffer+=char,this.textElem.innerHTML=`${isSpecial?this.typewriter.visibleBuffer:this._withLastCharSpan(this.typewriter.visibleBuffer)}<span style="visibility:hidden;">${this.typewriter.hiddenBuffer}</span>`}}}skip(){for(this.typewriter.text.split("").slice(this.typewriter.head);this.typewriter.head++,!(this.typewriter.head>=this.typewriter.length);){let char=this._headGetSpecialChar();""===char&&(char=this.typewriter.text[this.typewriter.head],this.typewriter.hiddenBuffer=this.typewriter.hiddenBuffer.substring(1)),this.typewriter.visibleBuffer+=char}this.textElem.innerHTML=`${this.typewriter.visibleBuffer}<span style="visibility:hidden;">${this.typewriter.hiddenBuffer}</span>`,this.typewriter.running=!1,this.typewriter.time=0}_parse(text){this.typewriter.lineBreaks=[];let i=text.indexOf("\n");for(;-1!==i;)this.typewriter.lineBreaks.push(i),(text=text.split("")).splice(i,1),text=text.join(""),i=text.indexOf("\n",i+1);return text}_headGetSpecialChar(){let char="";return this.typewriter.lineBreaks.includes(this.typewriter.head)&&(char="<br>",this.typewriter.lineBreaks.splice(this.typewriter.lineBreaks.indexOf(this.typewriter.head),1),this.typewriter.head--),char}_withLastCharSpan(text){return 1==text.length?`<span class="tw__lastchar">${text}</span>`:`${text.substring(0,text.length-1)}<span class="tw__lastchar">${text.substring(text.length-1)}</span>`}}!function(global){global=global.Noise={};function Grad(x,y,z){this.x=x,this.y=y,this.z=z}Grad.prototype.dot2=function(x,y){return this.x*x+this.y*y},Grad.prototype.dot3=function(x,y,z){return this.x*x+this.y*y+this.z*z};var grad3=[new Grad(1,1,0),new Grad(-1,1,0),new Grad(1,-1,0),new Grad(-1,-1,0),new Grad(1,0,1),new Grad(-1,0,1),new Grad(1,0,-1),new Grad(-1,0,-1),new Grad(0,1,1),new Grad(0,-1,1),new Grad(0,1,-1),new Grad(0,-1,-1)],p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],perm=new Array(512),gradP=new Array(512),F2=(global.seed=function(seed){0<seed&&seed<1&&(seed*=65536),(seed=Math.floor(seed))<256&&(seed|=seed<<8);for(var i=0;i<256;i++){var v=1&i?p[i]^255&seed:p[i]^seed>>8&255;perm[i]=perm[i+256]=v,gradP[i]=gradP[i+256]=grad3[v%12]}},global.seed(0),.5*(Math.sqrt(3)-1)),G2=(3-Math.sqrt(3))/6,G3=1/6;function fade(t){return t*t*t*(t*(6*t-15)+10)}function lerp(a,b,t){return(1-t)*a+t*b}global.simplex2=function(xin,yin){var s=(xin+yin)*F2,i=Math.floor(xin+s),s=Math.floor(yin+s),t=(i+s)*G2,xin=xin-i+t,yin=yin-s+t,t=yin<xin?(i1=1,0):(i1=0,1),x1=xin-i1+G2,y1=yin-t+G2,x2=xin-1+2*G2,y2=yin-1+2*G2,gi0=gradP[(i&=255)+perm[s&=255]],i1=gradP[i+i1+perm[s+t]],t=gradP[1+i+perm[1+s]],i=.5-xin*xin-yin*yin,s=i<0?0:(i*=i)*i*gi0.dot2(xin,yin),i=.5-x1*x1-y1*y1,gi0=i<0?0:(i*=i)*i*i1.dot2(x1,y1),xin=.5-x2*x2-y2*y2,yin=xin<0?0:(xin*=xin)*xin*t.dot2(x2,y2);return 70*(s+gi0+yin)},global.simplex3=function(xin,yin,zin){var s=(xin+yin+zin)*(1/3),i=Math.floor(xin+s),j=Math.floor(yin+s),s=Math.floor(zin+s),t=(i+j+s)*G3,xin=xin-i+t,yin=yin-j+t,zin=zin-s+t,t=yin<=xin?zin<=yin?(j2=i2=i1=1,k1=j1=0):i2=zin<=xin?(j2=k1=j1=0,i1=1):(j2=j1=i1=0,k1=1):yin<zin?(i2=j1=i1=0,j2=k1=1):xin<zin?(i2=k1=i1=0,j2=j1=1):(j2=i2=j1=1,k1=i1=0),x1=xin-i1+G3,y1=yin-j1+G3,z1=zin-k1+G3,x2=xin-i2+2*G3,y2=yin-j2+2*G3,z2=zin-t+2*G3,x3=xin-1+.5,y3=yin-1+.5,z3=zin-1+.5,gi0=gradP[(i&=255)+perm[(j&=255)+perm[s&=255]]],i1=gradP[i+i1+perm[j+j1+perm[s+k1]]],j1=gradP[i+i2+perm[j+j2+perm[s+t]]],k1=gradP[1+i+perm[1+j+perm[1+s]]],i2=.6-xin*xin-yin*yin-zin*zin,j2=i2<0?0:(i2*=i2)*i2*gi0.dot3(xin,yin,zin),t=.6-x1*x1-y1*y1-z1*z1,i=t<0?0:(t*=t)*t*i1.dot3(x1,y1,z1),j=.6-x2*x2-y2*y2-z2*z2,s=j<0?0:(j*=j)*j*j1.dot3(x2,y2,z2),i2=.6-x3*x3-y3*y3-z3*z3,gi0=i2<0?0:(i2*=i2)*i2*k1.dot3(x3,y3,z3);return 32*(j2+i+s+gi0)},global.perlin2=function(x,y){var X=Math.floor(x),Y=Math.floor(y),n00=(x-=X,y-=Y,gradP[(X&=255)+perm[Y&=255]].dot2(x,y)),n01=gradP[X+perm[1+Y]].dot2(x,y-1),n10=gradP[1+X+perm[Y]].dot2(x-1,y),X=gradP[1+X+perm[1+Y]].dot2(x-1,y-1),Y=fade(x);return lerp(lerp(n00,n10,Y),lerp(n01,X,Y),fade(y))},global.perlin3=function(x,y,z){var X=Math.floor(x),Y=Math.floor(y),Z=Math.floor(z),n000=(x-=X,y-=Y,z-=Z,gradP[(X&=255)+perm[(Y&=255)+perm[Z&=255]]].dot3(x,y,z)),n001=gradP[X+perm[Y+perm[1+Z]]].dot3(x,y,z-1),n010=gradP[X+perm[1+Y+perm[Z]]].dot3(x,y-1,z),n011=gradP[X+perm[1+Y+perm[1+Z]]].dot3(x,y-1,z-1),n100=gradP[1+X+perm[Y+perm[Z]]].dot3(x-1,y,z),n101=gradP[1+X+perm[Y+perm[1+Z]]].dot3(x-1,y,z-1),n110=gradP[1+X+perm[1+Y+perm[Z]]].dot3(x-1,y-1,z),X=gradP[1+X+perm[1+Y+perm[1+Z]]].dot3(x-1,y-1,z-1),Y=fade(x),Z=fade(y),x=fade(z);return lerp(lerp(lerp(n000,n100,Y),lerp(n001,n101,Y),x),lerp(lerp(n010,n110,Y),lerp(n011,X,Y),x),Z)}}(this);class Collision{}Collision.simpleBoxesOverlap=(b1,b2)=>b1.x1<b2.x2&&b2.x1<b1.x2&&b1.y1<b2.y2&&b2.y1<b1.y2;class Events{constructor(){this.eventListenerMap={},Events.instance=this}createEvent(eventName){this.eventListenerMap[eventName]=[]}registerEventListener(object,eventName){void 0===this.eventListenerMap[eventName]?console.warn("EVENT NOT REGISTERED: "+eventName):this.eventListenerMap[eventName].push(object)}unregisterEventListener(object,eventName){object=this.eventListenerMap[eventName].indexOf(object);-1===object?console.warn("Listener to unregister not found for event "+eventName):this.eventListenerMap[eventName].splice(object,1)}dispatch(eventName,data){if(void 0===this.eventListenerMap[eventName])console.warn("EVENT NOT REGISTERED: "+eventName);else{var handlerName=this.getEventHandlerName(eventName),listeners=this.eventListenerMap[eventName];for(let i=0;i<listeners.length;i++)void 0===listeners[i][handlerName]?console.warn("EVENT LISTENER NOT IMPLEMENTED "+listeners[i]+" FOR "+handlerName):listeners[i][handlerName](data)}}getEventHandlerName(eventName){return"on"+eventName.charAt(0).toUpperCase()+eventName.slice(1)}}class TimedSequence{constructor(sequence,loop=!1,target=null){this.sequence=sequence,this.labels=sequence.reduce((acc,obj,i)=>"label"in obj?acc[obj.label]=i:acc,{}),this.loop=loop,this.target=target,this.time=0,this.currentIndex=0,this.modifier=1,this.running=!1}start(at=0){this.currentIndex=at,this.time=0,this.sequence[this.currentIndex].action(this.target),this.running=!0}update(deltaTime){if(!this.running)return!1;if(this.time+=deltaTime*this.modifier,!(this.sequence[this.currentIndex].duration>this.time)){if(this.currentIndex+=1,this.sequence.length<=this.currentIndex){if(!this.loop)return this.running=!1;this.currentIndex=0}this.time=0,"goto"in this.sequence[this.currentIndex]?this.start(this.labels[this.sequence[this.currentIndex].goto]):this.sequence[this.currentIndex].action(this.target)}return this.currentIndex}}